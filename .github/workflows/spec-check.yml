name: Spec Check

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  spec-reference-check:
    name: Verify PR references a spec
    runs-on: ubuntu-latest
    steps:
      - name: Check PR body for spec reference
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const title = context.payload.pull_request.title || '';

            // Allow if PR only touches non-service paths
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            const serviceFiles = files.data.filter(f =>
              f.filename.startsWith('services/') ||
              f.filename.startsWith('infra/')
            );

            if (serviceFiles.length === 0) {
              console.log('No service/infra files changed. Spec check skipped.');
              return;
            }

            // Check for spec reference in PR body
            const specPattern = /spec[-:\s]+\d{3}/i;
            const closesPattern = /closes\s+#\d+/i;
            const hasSpec = specPattern.test(body) || closesPattern.test(body);

            if (!hasSpec) {
              core.setFailed(
                'PRs modifying services/ or infra/ must reference a spec.\n' +
                'Add "Spec: SPEC-XXX" or "Closes #N" to the PR description.\n' +
                'See specs/ directory for all spec files.'
              );
            } else {
              console.log('Spec reference found. Check passed.');
            }

  spec-file-lint:
    name: Lint spec files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check spec file format
        run: |
          for f in specs/*.md; do
            echo "Checking $f..."
            # Verify required headers exist
            grep -q "^# SPEC-" "$f" || (echo "FAIL: $f missing '# SPEC-' title" && exit 1)
            grep -q "^\*\*Status:\*\*" "$f" || (echo "FAIL: $f missing Status field" && exit 1)
            grep -q "^\*\*GitHub Issue:\*\*" "$f" || (echo "FAIL: $f missing GitHub Issue field" && exit 1)
          done
          echo "All spec files pass format check."
